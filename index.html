<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>Client attribute join</title>

    <script>
      var esriConfig = {
        has: {
          "featurelayer-pbf": 0
        }
      }
    </script>

    <link rel="stylesheet" href="https://jsdev.arcgis.com/next/esri/themes/light/main.css"/>
    <script src="https://jsdev.arcgis.com/next/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
    </style>
    <script>
      require([
        "esri/Map",
        "esri/layers/FeatureLayer",
        "esri/views/MapView",
        "esri/smartMapping/renderers/color",
        "esri/widgets/Legend",
        "esri/request",
        "esri/config",
      ], function (Map, FeatureLayer, MapView, colorRendererCreator, Legend, esriRequest, esriConfig) {

        (async () => {

          const geometryLayer = new FeatureLayer({
            portalItem: {
              id: "d3374b5003d548ea8fe72624326e8573"
            },
            outFields: ["FIPS"],
            renderer: {
              type: "simple",
              symbol: {
                type: "simple-fill",
                outline: {
                  width: 1,
                  color: "white"
                },
                color: "black"
              }
            }
          });

          const map = new Map({
            basemap: "gray-vector",
            layers: [ geometryLayer ],
            popup: {
              defaultPopupTemplateEnabled: true
            }
          });

          const view = new MapView({
            container: "viewDiv",
            map: map,
            extent: {
              "spatialReference": {
                  "latestWkid": 3857,
                  "wkid": 102100
              },
              "xmin": -13216539.98012612,
              "ymin": 3992633.8928405247,
              "xmax": -13095616.60137903,
              "ymax": 4117073.3748887316
            }
          });

          const key = "FIPS";

          const { data } = await esriRequest("data.json");
          console.log(data);
          esriConfig.request.interceptors.push({
            urls: geometryLayer.url,
            after: function(params) {
              if(params.data?.features?.length) {
                params.data.features.forEach(feature => {
                  if( data[feature.attributes[key]] ){
                    feature.attributes = {
                      ...feature.attributes,
                      num_cars: data[feature.attributes[key]]
                    }
                  }
                });
                console.log(params.data);
              }
            }
          });

          view.ui.add(new Legend({ view }), "bottom-left");

          geometryLayer.fields = [{
            name: "num_cars",
            alias: "Number of cars",
            type: "integer"
          }];

          console.log(geometryLayer);

          // const { renderer } = await colorRendererCreator.createContinuousRenderer({
          //   view,
          //   layer: geometryLayer,
          //   field: "num_cars",
          //   theme: "above-and-below"
          // });

          // geometryLayer.renderer = renderer;
        })()

      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
